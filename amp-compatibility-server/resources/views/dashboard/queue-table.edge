@layout( 'dashboard/base' )

@section('page')

	<div>
		<div id="messageContainer"></div>
		<ul class="nav nav-tabs nav-fill" id="myTab" role="tablist">

			@each( ( name, key ) in tabs )
			<li class="nav-item" role="presentation">
				<a id="{{key}}-tab" href="/admin/{{params.queue}}/{{key}}" role="tab" aria-controls="{{key}}"
				   class="nav-link {{ (key === params.status) ? 'active' : '' }}"
				   aria-selected="{{ key === params.status ? 'true' : 'false' }}">
					{{name}}&nbsp;<span class="badge bg-secondary">{{queueHealth[key] || "0"}}</span>
				</a>
			</li>
			@endeach

		</ul>

		@if( ! size( jobs ) )
			<div class="col-md-5 p-lg-5 mx-auto my-5 text-center mt-4">
				<p class="lead fw-normal">There isn't any job.</p>
			</div>
		@else

			<table class="table table-hover mt-4">
				<thead>
				<tr>
					@each( ( value, key ) in jobs[0] )
					<th scope="col">{{ upperFirst( snackCaseToString( key ) ) }}</th>
					@endeach
				</tr>
				</thead>
				<tbody>

				@each( job in jobs )

				<tr data-jobid="{{job.id}}">
					@each( ( value, key ) in job )
					@if( 'plugins' === key  && size( value ) )
						<td>
							<ul class="list-group list-group-flush mt-0 mb-0">
								@each( plugin in value )
								<li class="list-group-item bg-transparent">
									{{plugin.name}} {{ elIf( '($self)', plugin.version, plugin.version ) }}
								</li>
								@endeach
							</ul>
						</td>
					@elseif( 'theme' === key && size( value ) )
						<td>{{value[0].name}} {{ elIf( '($self)', value[0].version, value[0].version ) }}</td>
					@elseif( 'progress' === key )
						<td>{{value ? value + '%' : ' - '}}</td>
					@elseif( 'logs' === key )
						<td>
							<ul class="list-group list-group-flush mt-0 mb-0">
								@each( ( data, tryNo ) in value )
								<li class="list-group-item bg-transparent">
									<strong>Try {{tryNo}}</strong>:&nbsp;{{data.message}}
									@if( data.logFile )
										<a target="_blank" href="https://storage.cloud.google.com/{{data.logFile}}">
											Log
										</a>
									@endif
								</li>
								@endeach
							</ul>
						</td>
					@elseif( 'actions' === key )
						<td>
							@each( ( jobID, action ) in value )
								<button type="button" class="btn btn-sm btn-secondary btn-actions" data-action="{{action}}"
										data-jobid="{{jobID}}">
									{{ upperFirst( snackCaseToString( action ) ) }}
								</button>
							@endeach
						</td>
					@else
						<td>{{value ? value : ' - '}}</td>
					@endif
					@endeach
				</tr>
				@endeach

				</tbody>
			</table>

			{{{renderPagination(pagination)}}}

		@endif
	</div>
@endsection

@section('script')
	{{ script('js/queue-table') }}
@endsection
